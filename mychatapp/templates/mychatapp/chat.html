<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="{% static 'css/chat.css' %}" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playwrite+NZ:wght@100..400&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <title>ChatMates | Room</title>
</head>

<body>
  <div class="container">
    <!-- MENU -->
    <div class="menus">

      <a href="{% url 'mychat:index' %}">
        <button class="btn btn-home">
          <svg class="icon icon-home" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="50px" height="50px">
            <path
              d="M 25 1.0507812 C 24.7825 1.0507812 24.565859 1.1197656 24.380859 1.2597656 L 1.3808594 19.210938 C 0.95085938 19.550938 0.8709375 20.179141 1.2109375 20.619141 C 1.5509375 21.049141 2.1791406 21.129062 2.6191406 20.789062 L 4 19.710938 L 4 46 C 4 46.55 4.45 47 5 47 L 19 47 L 19 29 L 31 29 L 31 47 L 45 47 C 45.55 47 46 46.55 46 46 L 46 19.710938 L 47.380859 20.789062 C 47.570859 20.929063 47.78 21 48 21 C 48.3 21 48.589063 20.869141 48.789062 20.619141 C 49.129063 20.179141 49.049141 19.550938 48.619141 19.210938 L 25.619141 1.2597656 C 25.434141 1.1197656 25.2175 1.0507812 25 1.0507812 z M 35 5 L 35 6.0507812 L 41 10.730469 L 41 5 L 35 5 z" />
          </svg>
        </button>
      </a>

      <a href="{% url 'mychat:add_friend' %}">
        <button class="btn btn-addfrnd">
          <svg class="icon icon-addfrnd" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
            width="50px" height="50px">
            <path
              d="M411.1 466.2c77.1 0 139.6-61.2 139.6-136.7V284c0-75.5-62.5-136.7-139.6-136.7S271.5 208.5 271.5 284v45.5c0 75.5 62.5 136.7 139.6 136.7z m228.8 123.5C568.8 561.5 491.7 546 411.1 546c-80.5 0-157.4 15.5-228.4 43.6-41.5 19.1-70.7 62-70.7 112.4v56.2c0 37.1 23.8 68.3 56.2 78.5C246.3 855 327.6 865 411.1 865c83.4 0 164.6-10 242.6-28.4 32.6-10.1 56.5-41.2 56.5-78.6v-56.2c0-50.1-28.9-93-70.3-112.1z m170-223.2v-99.7H750v99.7h-99.7v59.8H750V526h59.8v-99.7h99.7v-59.8h-99.6z" />
          </svg>
        </button>
      </a>

      <a href="{% url 'mychat:update_profile' %}">
        <button class="btn btn-settings">
          <svg class="icon icon-settings" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M 900.035 200.551 L 587.708 20.2292 a 151.81 151.81 0 0 0 -151.416 0 L 123.965 200.551 a 151.825 151.825 0 0 0 -75.7082 131.127 v 360.644 a 151.84 151.84 0 0 0 75.7082 131.127 l 312.327 180.322 a 151.78 151.78 0 0 0 151.416 0 l 312.327 -180.322 a 151.84 151.84 0 0 0 75.7082 -131.127 V 331.678 a 151.825 151.825 0 0 0 -75.7082 -131.127 Z M 512 673.47 a 169.98 169.98 0 1 1 169.98 -169.965 a 169.98 169.98 0 0 1 -169.98 169.965 Z" />
          </svg>
        </button>
      </a>

    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- NAV -->
      <div class="nav-main">
        <div class="frnd-detail-chat">
          <a href="{% url 'mychat:index' %}">
            <svg class="icon icon-left-arrow" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 400.004 400.004" xml:space="preserve">
              <g>
                <path d="M382.688,182.686H59.116l77.209-77.214c6.764-6.76,6.764-17.726,0-24.485c-6.764-6.764-17.73-6.764-24.484,0L5.073,187.757
               c-6.764,6.76-6.764,17.727,0,24.485l106.768,106.775c3.381,3.383,7.812,5.072,12.242,5.072c4.43,0,8.861-1.689,12.242-5.072
               c6.764-6.76,6.764-17.726,0-24.484l-77.209-77.218h323.572c9.562,0,17.316-7.753,17.316-17.315
               C400.004,190.438,392.251,182.686,382.688,182.686z" />
              </g>
            </svg>
          </a>

          {% if friend.pic %}
          <img class="img-frnd-chat" src="{{ friend.pic.url }}" alt="user-profile" />
          {% else %}
          <img class="img-frnd-chat" src="{% static 'imgs/default-profile.jpg' %}" alt="user-profile" />
          {% endif %}
          <div>
            <h3 class="frnd-name-chat">{{ friend.name }}</h3>
          </div>
        </div>
        <a class="btn-remove-link" href="{% url 'mychat:remove_friend' friend.id %}">
          <button class="btn-edit-profile">Remove</button>
        </a>
      </div>

      <!-- CHAT -->
      <div class="chat-container">
        {% for chat in chats %}
        {% if chat.msg_sender == user and chat.msg_receiver == profile %}
        <div class="msg-container msg-container-own">
          {{chat}}
        </div>

        {% elif chat.msg_receiver == user and chat.msg_sender == profile %}
        <div class="msg-container msg-container-oth">
          {{chat}}
        </div>
        {% endif %}
        {% endfor %}
      </div>

      <!-- INPUT -->
      <div>
        <form action="" class="input-container" method="POST">
          {% csrf_token %}
          {{form.body}}
          <button type="submit" class="btn btn-send">Send</button>
        </form>
      </div>
    </div>

    <!-- DETAILS -->
    <div class="details">
      <h2 class="heading-details">{{ friend.name }}'s profile</h2>
      {% if friend.pic %}
      <img class="img-user" src="{{ friend.pic.url }}" alt="user-profile" />
      {% else %}
      <img class="img-user" src="{% static 'imgs/default-profile.jpg' %}" alt="user-profile" />
      {% endif %}
      <h3 class="user-name">{{ friend.name }}</h3>
      <a href="{% url 'mychat:remove_friend' friend.id %}">
        <button class="btn-edit-profile">Remove</button>
      </a>
    </div>

  </div>

  <!-- variable from views.py -->
  {{ chat_count|json_script:"chat_count" }}

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");


    let form = document.querySelector(".input-container");

    form.addEventListener("submit", sendChat);

    function sendChat(e) {
      e.preventDefault();

      let chatMessage = document.querySelector(".message-input").value;
      console.log(chatMessage);

      const data = { msg: chatMessage };
      let url = "{% url 'mychat:sent_msg' friend.id %}";

      fetch(url, {
        method: "POST", // or 'PUT'
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Success:", data);
          let chat_body = document.querySelector(".chat-container");
          let chatMessageBox = document.createElement("div");

          chatMessageBox.classList.add("msg-container");
          chatMessageBox.classList.add("msg-container-own");

          chatMessageBox.innerText = data;
          chat_body.append(chatMessageBox);
          document.querySelector(".message-input").value = ""
          var chat_container = document.querySelector(".chat-container");
          chat_container.scrollTop = chat_container.scrollHeight - chat_container.clientHeight;
        })

        .catch((error) => {
          console.error("Error:", error);
        });
    }



    setInterval(receivedMessages, 1000)

    let counter = JSON.parse(document.getElementById('chat_count').textContent);

    function receivedMessages() {

      let url = "{% url 'mychat:rec_msg' friend.id %}";

      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          console.log("Success:", data);


          if (data.length == 0) { }
          else {
            let lastMsg = data[data.length - 1]

            if (counter == data.length) { console.log("There is no new msg") }
            else {
              let chat_body = document.querySelector(".chat-container");
              let chatMessageBox = document.createElement("div");

              chatMessageBox.classList.add("msg-container");
              chatMessageBox.classList.add("msg-container-oth");

              chatMessageBox.innerText = lastMsg;
              chat_body.append(chatMessageBox);
              document.querySelector(".message-input").value = ""
              var chat_container = document.querySelector(".chat-container");
              chat_container.scrollTop = chat_container.scrollHeight - chat_container.clientHeight;
            }
          }

          counter = data.length
        })

        .catch((error) => {
          console.error("Error:", error);
        });

    }

    var chat_container = document.querySelector(".chat-container");
    chat_container.scrollTop = chat_container.scrollHeight - chat_container.clientHeight;

  </script>
</body>

</html>